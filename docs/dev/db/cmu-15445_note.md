主要收录笔者在学习 [CMU 15-445/645 :: Intro to Database Systems (Fall 2023)](https://15445.courses.cs.cmu.edu/fall2023/schedule.html) 以及阅读教材 [《数据库系统概念（原书第7版）》)](https://item.jd.com/13318646.html#crumb-wrap) 记下的笔记。

## Lecture #3 Database Storage I

课程主要讲解面向磁盘（非易失性存储介质）的数据库的设计理念。内存的访问速度比磁盘快的多（无论是顺序或者随机都很快）。一般来说数据库的大小远大于内存容量，数据库文件在磁盘中持久化存储。磁盘中随机读取比顺序读取慢，因此 DBMS 要尽可能保证数据在磁盘中顺序读取。

为了读写这些文件，DBMS 在必要时将其读入内存中，在必要时写回磁盘。

一些概念：

-   页面：页面存放数据，当 DBMS 需要特定数据时，实际是读入这条数据所在的页面。

-   页面大小：表示读入一次页面的数据量大小。默认页面大小见下表：

    | 默认页面大小 |                   DBMS                   |
    | :----------: | :--------------------------------------: |
    |     4KB      | SQLite、Oracle、DB2、RocksDB、WiredTiger |
    |     8KB      |         PostgresSQL、SQL Server          |
    |     16KB     |                  MySQL                   |

-   脏页面：页面被读入内存后如果发生改动，则与磁盘中的页面不一致，这样的页面称为脏页面。

-   干净页面：脏页面写回磁盘中变为干净页面。

### 不要使用 mmap

Andy 用了 30 分钟时间说明 **不要在 DBMS 中使用mmap（操作系统提供的虚拟内存）** ，mmap 对于只读程序是足够的，但对于文件同时被写入的程序，使用 mmap 会复杂很多。

使用 mmap 的弊端：

1.   事务安全：OS 可能在任意时间将脏页面写回磁盘。
2.   I/O 停顿：DBMS 不知道哪个页面在内存中，请求不在内存中的页面时会出现 I/O 停顿。
3.   错误处理：DBMS 需要处理 SIGBUS 信号。
4.   性能问题。

### 数据库存储

#### 堆文件组织

![file_and_pages](./file_and_pages.png)





